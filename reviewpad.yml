api-version: reviewpad.com/v3.x

labels:
  ship:
    color: 76dbbe
  show:
    color: 2986cc
  ask:
    color: c90076

groups:
  - name: maintainers
    kind: developers
    # The expression is wrapped in quotes to avoid YAML parsing errors
    spec: '["marcelosousa", "ferreiratiago", "shay2025"]'

rules:
  - name: authored-by-maintainers
    spec: $isElementOf($author(), $group("maintainers"))

  - name: authored-by-external-contributors
    spec: $isElementOf($author(), $group("maintainers")) == false

  - name: ship-strategy
    spec: $contains($description(), "[x] Ship:") || $isElementOf("ship", $labels())

  - name: show-strategy
    spec: $contains($description(), "[x] Show:") || $isElementOf("show", $labels())

  - name: explicit-ask-strategy
    spec: $contains($description(), "[x] Ask:") || $isElementOf("ask", $labels())

  - name: ask-strategy
    spec: $rule("authored-by-external-contributors") || $rule("explicit-ask-strategy") || (!$rule("ship-strategy") && !$rule("show-strategy"))

  - name: missing-merge-strategy
    # The expression is wrapped in quotes to avoid YAML parsing errors
    spec: '!$rule("ship-strategy") && !$rule("show-strategy") && !$rule("ask-strategy")'

  - name: several-merge-strategies-selected
    spec: ($rule("ship-strategy") && $rule("show-strategy")) || ($rule("ship-strategy") && $rule("ask-strategy")) || ($rule("show-strategy") && $rule("ask-strategy"))

workflows:
  - name: first-time-issue-contributor
    on:
      - "issue"
    always-run: true
    if:
      - rule: $issueCountBy($author(), "all") == 1
        extra-actions:
          - $commentOnce($sprintf("Welcome @%v! Thank you so much for your first issue!", [$author()]))

  - name: first-time-pr-contributor
    on:
      - "pull_request"
    always-run: true
    if:
      - rule: $pullRequestCountBy($author(), "all") == 1
        extra-actions:
          - $commentOnce($sprintf("Welcome @%v! Thank you so much for your first pull request!", [$author()]))

  - name: default-review-process
    always-run: true
    if:
      - rule: authored-by-maintainers
        extra-actions:
          - $assignReviewer($group("maintainers"), 1, "reviewpad")
          - $assignAssignees([$author()])
      - rule: authored-by-external-contributors
        extra-actions:
          - $addLabel("external-contribution")
          - $assignReviewer($group("maintainers"), 1, "reviewpad")
          - $assignAssignees(["ferreiratiago"])

  - name: changes-to-use-cases
    always-run: true
    if:
      - rule: $hasFilePattern("docs/use-cases/**")
    then:
      - $info("If you are adding a new use case, please do not forget to update the `sidebar.js`")

  - name: conventions
    always-run: true
    if:
      - rule: $hasLinkedIssues() == false
        extra-actions:
          - $warn("Please make sure that you have linked an issue to the pull request.")

  - name: validate-state
    if:
      - rule: missing-merge-strategy
        extra-actions:
          - $error("Please select a merge strategy - ship, show, or ask")
      - rule: several-merge-strategies-selected
        extra-actions:
          - $error("Please select only one merge strategy - ship, show, or ask")

  - name: label-ship-show-ask
    if:
      - rule: ship-strategy
        extra-actions:
          - $addLabel("ship")
          - $removeLabels(["ask", "show"])
          - $merge("rebase")
      - rule: show-strategy
        extra-actions:
          - $addLabel("show")
          - $removeLabels(["ship", "ask"])
          - $commentOnce("Please open an issue to review this PR and merge it!")
      - rule: ask-strategy
        extra-actions:
          - $addLabel("ask")
          - $removeLabels(["ship", "show"])
